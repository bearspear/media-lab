<div class="detail-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <i class="pi pi-spinner loading-spinner"></i>
    <p>Loading item details...</p>
  </div>

  <!-- Item Detail -->
  <div *ngIf="!loading && item" class="detail-content">
    <!-- Header -->
    <div class="detail-header">
      <button pButton type="button" icon="pi pi-arrow-left" class="p-button-text p-button-secondary back-btn" (click)="goBack()" label="Back to Library"></button>
      <div class="header-actions">
        <button pButton type="button" icon="pi pi-pencil" class="p-button-outlined" (click)="editItem()" label="Edit"></button>
        <button pButton type="button" icon="pi pi-trash" class="p-button-outlined p-button-danger" (click)="deleteItem()" label="Delete"></button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="detail-main">
      <!-- Cover Image -->
      <div class="cover-section">
        <img [src]="getCoverUrl()" [alt]="item.title" class="cover-image">
        <button *ngIf="item.filePath" pButton type="button" icon="pi pi-download" class="p-button-success download-btn" (click)="downloadFile()" label="Download File"></button>
      </div>

      <!-- Information -->
      <div class="info-section">
        <!-- Title & Type -->
        <div class="title-section">
          <h1 class="item-title">{{ item.title }}</h1>
          <div class="title-meta">
            <p-chip [label]="item.type" styleClass="type-chip"></p-chip>
            <p-chip [label]="item.format || 'Unknown Format'" styleClass="format-chip"></p-chip>
            <p-tag *ngIf="item.readingStatus" [value]="getReadingStatusLabel(item.readingStatus)" [severity]="getReadingStatusSeverity(item.readingStatus)"></p-tag>
          </div>
        </div>

        <!-- Rating -->
        <div *ngIf="item.rating" class="rating-section">
          <p-rating [(ngModel)]="item.rating" [readonly]="true"></p-rating>
          <span class="rating-text">{{ item.rating }}/5</span>
        </div>

        <p-divider></p-divider>

        <!-- Description -->
        <div *ngIf="item.description" class="info-group">
          <h3 class="info-label">Description</h3>
          <p class="info-value description-text">{{ item.description }}</p>
        </div>

        <!-- Metadata Grid -->
        <div class="metadata-grid">
          <!-- Authors -->
          <div class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-user"></i>
              <span>Authors</span>
            </label>
            <p class="metadata-value">{{ getAuthorNames(item.authors || []) }}</p>
          </div>

          <!-- Publisher -->
          <div class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-building"></i>
              <span>Publisher</span>
            </label>
            <p class="metadata-value">{{ getPublisherName(item.publisher) }}</p>
          </div>

          <!-- Published Year -->
          <div *ngIf="item.publishedYear" class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-calendar"></i>
              <span>Published Year</span>
            </label>
            <p class="metadata-value">{{ item.publishedYear }}</p>
          </div>

          <!-- ISBN -->
          <div *ngIf="item.isbn" class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-book"></i>
              <span>ISBN</span>
            </label>
            <p class="metadata-value">{{ item.isbn }}</p>
          </div>

          <!-- LCCN -->
          <div *ngIf="item.lccn" class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-bookmark"></i>
              <span>LCCN</span>
            </label>
            <p class="metadata-value">{{ item.lccn }}</p>
          </div>

          <!-- Language -->
          <div *ngIf="item.language" class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-globe"></i>
              <span>Language</span>
            </label>
            <p class="metadata-value">{{ item.language }}</p>
          </div>

          <!-- File Size (deprecated) -->
          <div *ngIf="item.fileSize && !hasFiles()" class="metadata-item">
            <label class="metadata-label">
              <i class="pi pi-database"></i>
              <span>File Size</span>
            </label>
            <p class="metadata-value">{{ item.fileSize }}</p>
          </div>
        </div>

        <!-- Digital Files Section -->
        <div *ngIf="hasFiles()" class="info-group files-section">
          <h3 class="info-label">
            <i class="pi pi-file"></i>
            Available Files ({{ item.files!.length }})
          </h3>

          <p-table [value]="item.files!" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Format</th>
                <th>Size</th>
                <th>Version</th>
                <th>Notes</th>
                <th style="width: 100px">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-file>
              <tr [class.primary-file]="file.isPrimary">
                <td>
                  <p-chip [label]="getFormatDisplay(file.format)" styleClass="format-chip"></p-chip>
                  <p-tag *ngIf="file.isPrimary" value="Primary" severity="success" styleClass="ml-2"></p-tag>
                </td>
                <td>{{ getFileSizeDisplay(file.fileSize) }}</td>
                <td>{{ file.version || '-' }}</td>
                <td>{{ file.notes || '-' }}</td>
                <td>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-book"
                    class="p-button-text p-button-sm"
                    (click)="readFile(file)"
                    pTooltip="Read in browser"
                    tooltipPosition="top">
                  </button>
                  <button
                    pButton
                    type="button"
                    icon="pi pi-download"
                    class="p-button-text p-button-sm"
                    (click)="downloadFileById(file)"
                    pTooltip="Download file"
                    tooltipPosition="top">
                  </button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <p-divider></p-divider>

        <!-- Genres -->
        <div *ngIf="item.genres && item.genres.length > 0" class="info-group">
          <h3 class="info-label">
            <i class="pi pi-tag"></i>
            Genres
          </h3>
          <div class="chip-list">
            <p-chip *ngFor="let genre of item.genres" [label]="genre.name" styleClass="genre-chip"></p-chip>
          </div>
        </div>

        <!-- Tags -->
        <div *ngIf="item.tags && item.tags.length > 0" class="info-group">
          <h3 class="info-label">
            <i class="pi pi-tags"></i>
            Tags
          </h3>
          <div class="chip-list">
            <p-chip *ngFor="let tag of item.tags" [label]="getTagLabel(tag)" styleClass="custom-chip"></p-chip>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Timestamps -->
        <div class="timestamps">
          <div class="timestamp-item">
            <i class="pi pi-plus-circle"></i>
            <span>Added: {{ formatDate(item.createdAt) }}</span>
          </div>
          <div class="timestamp-item">
            <i class="pi pi-refresh"></i>
            <span>Updated: {{ formatDate(item.updatedAt) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
